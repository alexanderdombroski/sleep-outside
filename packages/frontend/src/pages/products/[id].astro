---
import Layout from "../../layouts/Layout.astro";
import { type CollectionEntry, getCollection } from "astro:content";

export async function getStaticPaths() {
  const products = await getCollection("products");

  return products.map((product) => ({
    params: { id: product.id },
    props: product,
  }));
}

type Props = CollectionEntry<"products">;
const product = Astro.props;
const title = product.data.name;
---

<Layout title={title}>
  <section class="product-detail">
    <h3>Marmot</h3>

    <h2 class="divider">{product.data.name}</h2>

    <img
      class="divider"
      src={product.data.images.primaryExtraLarge}
      alt={product.data.name}
    />

    <p class="product-card__price">${product.data.listPrice}</p>
    <p class="product-card__discount">
      {
        product.data.discountPercentage
          ? `${product.data.discountPercentage}% off`
          : "No discount"
      }
    </p>
    <p class="product-card__final-price">${product.data.finalPrice}</p>

    <div class="product__color">
      {JSON.stringify(product.data.colors)}

      <p class="product__description">{product.data.descriptionHtmlSimple}</p>

      <div class="product-detail__add">
        <button id="addToCart" data-product={JSON.stringify(product.data)}>
          Add to Cart
        </button>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { addToCart } from "../../js/cart.ts";
  import { sendAlert } from "../../components/alert/alert.svelte.ts";
  import type { AlertOptions } from "../../components/alert";

  const btn = document.querySelector("#addToCart");

  if (btn) {
    btn.addEventListener("click", (event) => {
      const target = event.currentTarget as HTMLButtonElement;
      const productString = target.dataset.product;

      if (productString) {
        const productData = JSON.parse(productString);
        addToCart(productData);

        const alertOptions: AlertOptions = {
          message: `${productData.name} was added to your cart!`,
          type: "success",
          duration: 3000,
        };
        sendAlert(alertOptions);
      }
    });
  }
</script>
